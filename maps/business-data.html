<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:9003 http://localhost:9010 http://localhost:8080 https://localhost:9003 https://localhost:9010 https://localhost:8080; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com data:; default-src 'self' http://localhost:9003 http://localhost:9010 http://localhost:8080 https://localhost:9003 https://localhost:9010 https://localhost:8080 data: blob:;">
    <title>Business Data - Muslim Association of Puget Sound</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>" type="image/svg+xml">
    
    <!-- Google Fonts - Poppins (matching main dashboard) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
:root {
    /* Primary brand colors - matching main dashboard */
    --primary-color: #A51D35;
    --primary-hover: #8B1A2E;
    --accent-color: #8B1A2E;
    
    /* Light mode colors */
    --bg-primary: #FFFFFF;
    --bg-secondary: #F9FAFB;
    --bg-tertiary: #F3F4F6;
    --text-primary: #111827;
    --text-secondary: #6B7280;
    --text-tertiary: #9CA3AF;
    --border-color: #E5E7EB;
    --border-hover: #D1D5DB;
    
    /* Font and spacing */
    --font-family: Poppins, sans-serif;
    --border-radius: 8px;
    --spacing: 16px;
}

* {
    box-sizing: border-box;
}

body {
    font-family: Poppins, sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #A51D35 0%, #8B1A2E 50%, #f0f4f8 100%);
    background-attachment: fixed;
    color: #242424;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    line-height: 1.6;
}

.dashboard-grid {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    max-width: 1400px;
    margin: 0 auto;
    padding: 16px;
}

.dashboard-header {
    background: linear-gradient(135deg, #A51D35 0%, #8B1A2E 100%);
    color: #ffffff;
    padding: 40px;
    border-radius: 15px;
    margin-bottom: 40px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    text-align: center;
    position: relative;
    overflow: hidden;
}

.dashboard-header-top {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 10;
}

.dashboard-header h1 {
    margin: 0 0 20px 0;
    font-size: 3em;
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.dashboard-nav {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 20px;
}

.dashboard-header-top .nav-button {
    margin: 0;
}

.nav-button {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    padding: 12px 24px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
}

.nav-button:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
}

.dashboard-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: calc(16px * 1.5);
}

.entity-types-section {
    margin-bottom: calc(16px * 1.5);
    padding: 24px;
    background: linear-gradient(to bottom, #f9fafb, white);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.entity-types-section h3 {
    font-size: 2em;
    margin-bottom: calc(16px * 0.5);
    color: #1f2937;
    font-weight: 700;
}

.section-description {
    color: #6b7280;
    margin-bottom: 24px;
    font-size: 1rem;
}

.entity-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 24px;
}

.entity-type-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 2px solid #e5e7eb;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    gap: calc(16px * 0.75);
}

.entity-type-card:hover {
    border-color: var(--entity-color, #A51D35);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.entity-icon {
    font-size: 2.5rem;
    margin-bottom: calc(16px * 0.5);
}

.entity-info {
    flex: 1;
}

.entity-name {
    margin: 0 0 calc(16px * 0.5) 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.entity-count {
    font-size: 0.95rem;
    color: #6b7280;
    font-weight: 400;
    margin-left: 0.5rem;
}

.entity-sources {
    font-size: 0.9rem;
    color: #9ca3af;
}

.entity-search-btn {
    background: var(--entity-color, #A51D35);
    color: white;
    border: none;
    border-radius: 8px;
    padding: calc(16px * 0.75) 16px;
    cursor: pointer;
    font-weight: 500;
    transition: opacity 0.2s;
    margin-top: calc(16px * 0.5);
}

.entity-search-btn:hover {
    opacity: 0.9;
}

/* Search Capabilities Section */
.search-capabilities-section {
    margin-bottom: calc(16px * 1.5);
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.search-capabilities-section h3 {
    font-size: 1.5rem;
    margin-bottom: calc(16px * 0.5);
    color: #1f2937;
}


@media (max-width: 768px) {
    .entity-types-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-header h1 {
        font-size: 2em;
    }
}
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <header class="dashboard-header">
            <div class="dashboard-header-top">
                <a href="/tenants/maps/app" class="nav-button">‚Üê Back to Dashboard</a>
            </div>
            <h1>üìä Business Data</h1>
        </header>
        
        <main class="dashboard-main">
            <section class="entity-types-section">
                <h3>üìä Discovered Business Entities</h3>
                <p class="section-description">These entity types were automatically discovered from your data:</p>
                <div class="entity-types-grid" id="entity-types-grid">
                    <!-- Entity cards will be dynamically generated from Crema data -->
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="animation: pulse 1.5s ease-in-out infinite;">‚è≥ Loading...</div>
                    </div>
                </div>
            </section>
            
            <!-- Search Section -->
            <section class="search-capabilities-section">
                <h3>üîç Smart Search</h3>
                <p class="section-description">Search across your data using natural language or specific queries:</p>
                <div class="search-input-container" style="margin-bottom: 1.5rem;">
                    <input type="text" id="global-search-input" placeholder="Enter search query (e.g., &quot;customers from last month&quot; or &quot;ai_category=payment&quot;)" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); border-radius: 8px; font-size: 1rem; margin-bottom: 0.5rem;">
                    <button id="global-search-btn" style="padding: 0.75rem 1.5rem; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; width: 100%; transition: background 0.2s;" onmouseover="this.style.background='var(--primary-hover)'" onmouseout="this.style.background='var(--primary-color)'">Search</button>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Results Modal -->
    <div id="results-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 2rem auto; background: var(--bg-primary); border-radius: 12px; padding: 2rem; box-shadow: 0 10px 40px rgba(165, 29, 53, 0.3); border-top: 4px solid #A51D35;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(165, 29, 53, 0.1); padding-bottom: 1rem;">
                <h2 id="results-modal-title" style="margin: 0; color: var(--primary-color); font-weight: 600;">Search Results</h2>
                <button id="close-results-modal" style="background: var(--button-primary-bg); color: var(--button-primary-text); border: none; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='var(--primary-hover)'" onmouseout="this.style.background='var(--button-primary-bg)'">&times;</button>
            </div>
            <div id="results-modal-content" style="max-height: 70vh; overflow-y: auto; color: var(--text-primary);"></div>
        </div>
    </div>

    <script>
// Auto-generated JavaScript for maps
const TENANT_ID = "maps";
const BUSINESS_TYPE = "non_profit_organization";
const API_URL = "http://localhost:9010";

// Crema data (discovered entities and categories)
let CREMA_DATA = null;

// Fetch Crema data for latest discovery (via Kandaq API, not Sanduq directly)
async function fetchCremaData() {
    try {
        const response = await fetch(API_URL + '/api/crema', {
            headers: {
                'X-Tenant-ID': TENANT_ID,
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();
        if (data.success && data.data) {
            CREMA_DATA = data.data;
            // API returns data_types, not entityTypes
            // Also extract entities from sources array
            const dataTypes = CREMA_DATA.data_types || [];
            const sourcesEntities = (CREMA_DATA.sources || []).flatMap(s => s.entities || []);
            // Combine both sources - prefer data_types as primary source
            const allEntities = dataTypes.length > 0 ? dataTypes : sourcesEntities;
            console.log('üìä Found', allEntities.length, 'entity types from Crema');
            console.log('üìä Sample entities:', allEntities.slice(0, 3).map(e => ({
                key: e.data_type || e.key,
                count: e.count,
                name: e.name || e.display_name
            })));
            updateEntityCounts(allEntities);
        } else {
            console.error('Failed to fetch Crema data:', data);
            showError('Failed to load business data');
        }
    } catch (error) {
        console.error('Error fetching Crema data:', error);
        showError('Error loading business data: ' + error.message);
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Map SF Symbols to Font Awesome icons
function mapSFIconToFontAwesome(sfIcon) {
    if (!sfIcon) return 'fa-file';
    
    const iconMap = {
        'person.2': 'fa-users',
        'person.3': 'fa-users',
        'person.circle': 'fa-user-circle',
        'person.badge.plus': 'fa-user-plus',
        'person.crop.circle': 'fa-user-circle',
        'person.circle.fill': 'fa-user-circle',
        'doc': 'fa-file',
        'doc.text': 'fa-file-alt',
        'doc.on.doc': 'fa-copy',
        'doc.text.fill': 'fa-file-alt',
        'doc.text.magnifyingglass': 'fa-file-search',
        'doc.richtext': 'fa-file-alt',
        'heart': 'fa-heart',
        'creditcard': 'fa-credit-card',
        'dollarsign.circle': 'fa-dollar-sign',
        'dollarsign.square': 'fa-dollar-sign',
        'cart': 'fa-shopping-cart',
        'book': 'fa-book',
        'cube': 'fa-cube',
        'cube.box': 'fa-box',
        'folder': 'fa-folder',
        'clock': 'fa-clock',
        'gear': 'fa-cog',
        'list.bullet': 'fa-list',
        'square.and.pencil': 'fa-pencil-square',
        'truck.box': 'fa-truck',
        'star.bubble': 'fa-star',
        'star': 'fa-star',
        'photo': 'fa-image',
        'video': 'fa-video',
        'music.note': 'fa-music',
        'archivebox': 'fa-archive',
    };
    
    if (iconMap[sfIcon]) {
        return iconMap[sfIcon];
    }
    
    const baseIcon = sfIcon.split('.')[0];
    if (iconMap[baseIcon]) {
        return iconMap[baseIcon];
    }
    
    return 'fa-file';
}

// Error handling
function showError(message) {
    const entityGrid = document.getElementById('entity-types-grid');
    if (entityGrid) {
        entityGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444; background: #fee; border: 1px solid #fcc; border-radius: 8px;"><strong>‚ö†Ô∏è Error:</strong> ' + escapeHtml(message) + '</div>';
    }
}

// Generate entity cards dynamically from Crema data
function generateEntityCardsFromCrema(entityTypes) {
    if (!entityTypes || entityTypes.length === 0) {
        console.log('‚ö†Ô∏è No entity types from Crema to display');
        const entityGrid = document.getElementById('entity-types-grid');
        if (entityGrid) {
            entityGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No business entities found</div>';
        }
        return;
    }
    
    const entityGrid = document.getElementById('entity-types-grid');
    if (!entityGrid) {
        console.error('‚ùå Could not find entity-types-grid element');
        return;
    }
    
    entityGrid.innerHTML = '';
    
    const businessEntityTypes = entityTypes.filter(et => {
        const count = et.count || 0;
        // Handle both data_type and key fields
        const key = ((et.data_type || et.key || '').toLowerCase());
        const excludedTypes = ['text', 'file', 'image', 'video', 'audio', 'document', 'archive', 'binary'];
        return count > 0 && !excludedTypes.includes(key);
    });
    
    console.log('üîÑ Generating ' + businessEntityTypes.length + ' entity cards from Crema data');
    
    businessEntityTypes.forEach(entityType => {
        // Handle both data_types format (has data_type field) and sources.entities format (has key field)
        const key = entityType.data_type || entityType.key || '';
        const name = entityType.name || entityType.display_name || key;
        const count = entityType.count || 0;
        const color = entityType.color || '#A51D35'; // Use MAPS brand color as default
        const sources = entityType.sources || [];
        
        const sourcesText = sources.length > 0 
            ? sources.map(s => s.system).join(', ')
            : 'unknown';
        
        const card = document.createElement('div');
        card.className = 'entity-type-card';
        card.setAttribute('style', `--entity-color: ${color};`);
        
        card.innerHTML = 
            '<div class="entity-info">' +
                '<h4 class="entity-name"><span class="entity-name-text">' + escapeHtml(name) + '</span><span class="entity-count">' + count.toLocaleString() + '</span></h4>' +
                '<div class="entity-sources">From: ' + escapeHtml(sourcesText) + '</div>' +
            '</div>';
        
        card.style.cursor = 'pointer';
        card.setAttribute('data-entity-type', key);
        card.setAttribute('data-entity-name', name);
        
        // Add click handler to open entity data modal directly
        card.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (typeof window.showEntityData === 'function') {
                window.showEntityData(key, name);
            } else {
                console.error('showEntityData function not available');
            }
        });
        
        entityGrid.appendChild(card);
    });
    
    console.log(`‚úÖ Generated ${businessEntityTypes.length} entity cards`);
}

// Update entity counts from Crema
function updateEntityCounts(entityTypes) {
    generateEntityCardsFromCrema(entityTypes);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Loading business data for tenant:', TENANT_ID);
    await fetchCremaData();
    
    // Setup search functionality
    const searchInput = document.getElementById('global-search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchBtn = document.getElementById('global-search-btn');
                if (searchBtn) {
                    searchBtn.click();
                }
            }
        });
    }
    
    // Setup search button click handler
    const searchBtn = document.getElementById('global-search-btn');
    if (searchBtn) {
        searchBtn.addEventListener('click', async () => {
            const query = searchInput?.value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';
            const results = await searchGlobal(query);
            showResultsModal('Search Results: "' + query + '" (' + results.length + ' found)', results);
            searchBtn.disabled = false;
            searchBtn.textContent = 'Search';
        });
    }
    
    // Setup modal close handler
    const closeBtn = document.getElementById('close-results-modal');
    const modal = document.getElementById('results-modal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeResultsModal);
    }
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeResultsModal();
            }
        });
    }
});

// Global search function
async function searchGlobal(query) {
    try {
        console.log('üîç Global search:', query);
        const response = await fetch(API_URL + '/api/search', {
            method: 'POST',
            headers: {
                'X-Tenant-ID': TENANT_ID,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: query,
                limit: 100,
                routing: 'auto'  // Use smart router - will route to AI for natural language queries
            })
        });
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Search failed:', response.status, response.statusText, errorText);
            
            // Parse error message for better user feedback
            let errorMessage = 'Search failed';
            try {
                const errorData = JSON.parse(errorText);
                if (errorData.error && errorData.error.includes('Connection refused')) {
                    errorMessage = 'Search service is temporarily unavailable. Please try again in a moment.';
                } else if (errorData.error) {
                    errorMessage = errorData.error;
                }
            } catch (e) {
                // If parsing fails, use generic message
            }
            
            // Show error to user
            showResultsModal('Search Error', []);
            const contentEl = document.getElementById('results-modal-content');
            if (contentEl) {
                contentEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;"><strong>‚ö†Ô∏è Error:</strong> ' + escapeHtml(errorMessage) + '<br><br><small style="color: #6b7280;">The search service may be starting up. Please try again in a few seconds.</small></div>';
            }
            return [];
        }
        const data = await response.json();
        console.log('‚úÖ Search response:', {
            success: data.success,
            routing: data.data?.routing || 'unknown',
            tool_calls_used: data.data?.tool_calls_used || false,
            results_count: data.data?.results?.length || data.results?.length || 0
        });
        // Handle both response formats: {success: true, results: [...]} and {success: true, data: {results: [...]}}
        if (data.success) {
            const results = data.results || (data.data && data.data.results) || [];
            console.log('üìä Search results with formatting:', results.length, 'results');
            if (results.length > 0) {
                console.log('üìã First result fields:', Object.keys(results[0]));
                console.log('üìã Sample result:', {
                    title: results[0].title,
                    description: results[0].description,
                    date: results[0].date,
                    amount: results[0].amount
                });
            }
            return results;
        }
        return [];
    } catch (error) {
        console.error('‚ö†Ô∏è Search error:', error);
        return [];
    }
}

// Results modal functions
function showResultsModal(title, results) {
    const modal = document.getElementById('results-modal');
    const titleEl = document.getElementById('results-modal-title');
    const contentEl = document.getElementById('results-modal-content');
    
    if (!modal || !titleEl || !contentEl) return;
    
    // Show the modal
    modal.style.display = 'block';
    
    titleEl.textContent = title;
    
    if (results.length === 0) {
        contentEl.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No results found.</p>';
    } else {
        // Extract search query from title for highlighting
        const searchQueryMatch = title.match(/\"([^\"]+)\"/);
        const searchQuery = searchQueryMatch ? searchQueryMatch[1].toLowerCase() : '';
        
        // Helper function to highlight search terms in text
        function highlightText(text, query) {
            if (!query || !text) return escapeHtml(String(text));
            const escapedText = escapeHtml(String(text));
            const regex = new RegExp('(' + escapeHtml(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return escapedText.replace(regex, '<mark style="background: #fef08a; padding: 0.1em 0.2em; border-radius: 3px; font-weight: 600;">$1</mark>');
        }
        
        // Enhanced results display - show formatted details for each result
        let html = '<div style="display: grid; gap: 1rem;">';
        results.forEach((result, index) => {
            // Use formatted fields from API (title, description, date, etc.)
            const title = result.title || result.id || `Result ${index + 1}`;
            const displayType = result.display_type || result.data_type || 'unknown';
            const description = result.description || '';
            const date = result.date || '';
            const dueDate = result.due_date || '';
            const amount = result.amount;
            const balance = result.balance;
            const vendor = result.vendor || result.customer || result.donor || '';
            const account = result.account || '';
            const docNumber = result.doc_number || result.invoice_number || result.receipt_number || '';
            const lineItemsCount = result.line_items_count || 0;
            
            html += '<div style="background: white; border: 1px solid rgba(165, 29, 53, 0.2); border-radius: 8px; padding: 1.25rem; box-shadow: 0 2px 4px rgba(165, 29, 53, 0.1);">';
            
            // Title and type
            html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">';
            html += '<div style="flex: 1;">';
            html += '<div style="font-weight: 700; font-size: 1.15rem; color: #A51D35; margin-bottom: 0.25rem;">' + highlightText(title, searchQuery) + '</div>';
            html += '<div style="font-size: 0.85rem; color: #6b7280; text-transform: capitalize;">' + escapeHtml(displayType) + '</div>';
            html += '</div>';
            if (amount !== undefined && amount !== null) {
                html += '<div style="font-weight: 700; font-size: 1.1rem; color: #059669; white-space: nowrap; margin-left: 1rem;">$' + parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
            }
            html += '</div>';
            
            // Description
            if (description) {
                html += '<div style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.75rem; line-height: 1.5;">' + highlightText(description, searchQuery) + '</div>';
            }
            
            // Details grid
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">';
            
            // Date
            if (date) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Date:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(date) + '</span></div>';
            }
            
            // Due Date
            if (dueDate) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Due Date:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(dueDate) + '</span></div>';
            }
            
            // Vendor/Customer/Donor
            if (vendor) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">' + (result.vendor ? 'Vendor' : result.customer ? 'Customer' : 'Donor') + ':</strong><br><span style="color: var(--text-primary);">' + escapeHtml(vendor) + '</span></div>';
            }
            
            // Account
            if (account) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Account:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(account) + '</span></div>';
            }
            
            // Document Number
            if (docNumber) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Document #:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(docNumber) + '</span></div>';
            }
            
            // Balance (if different from amount)
            if (balance !== undefined && balance !== null && balance !== amount) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Balance:</strong><br><span style="color: ' + (parseFloat(balance) > 0 ? '#dc2626' : '#059669') + ';">$' + parseFloat(balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</span></div>';
            }
            
            // Line Items Count
            if (lineItemsCount > 0) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Line Items:</strong><br><span style="color: var(--text-primary);">' + lineItemsCount + '</span></div>';
            }
            
            html += '</div>'; // End details grid
            
            html += '</div>'; // End result card
        });
        html += '</div>';
        
        html += '<div style="text-align: center; color: #6b7280; margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.85rem;">';
        html += '<strong>Total:</strong> ' + results.length + ' result' + (results.length !== 1 ? 's' : '');
        html += '</div>';
        contentEl.innerHTML = html;
    }
    
    modal.style.display = 'block';
}

function closeResultsModal() {
    const modal = document.getElementById('results-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Function to open file in OS default viewer/player
function openFile(fileId, filePath, mimeType) {
    if (!fileId || fileId === '') {
        console.error('File ID not available. File data:', { fileId, filePath, mimeType });
        alert('File ID not available. Cannot open file without proper identifier.\n\nFile Path: ' + (filePath || 'N/A'));
        return;
    }
    
    // Construct file URL using Kandaq API content endpoint
    const fileUrl = API_URL + '/api/tenants/' + TENANT_ID + '/content/' + encodeURIComponent(fileId);
    
    // Open in new tab
    window.open(fileUrl, '_blank');
}

// Format field value for better readability (HTML version)
window.formatFieldValueHTML = function(value, fieldName) {
    if (value === null || value === undefined || value === '') {
        return '<span style="color: #9ca3af; font-style: italic;">(empty)</span>';
    }
    
    // Handle objects/arrays
    if (typeof value === 'object') {
        if (Array.isArray(value)) {
            if (value.length === 0) return '<span style="color: #9ca3af;">(empty array)</span>';
            return value.map(item => {
                if (typeof item === 'object') {
                    return JSON.stringify(item, null, 2);
                }
                return String(item);
            }).join(', ');
        }
        // Object - try to format nicely
        const keys = Object.keys(value);
        if (keys.length === 0) return '<span style="color: #9ca3af;">(empty object)</span>';
        if (keys.length <= 3) {
            // Small object - show as formatted name-value pairs
            return '<div style="display: flex; flex-direction: column; gap: 0.25rem;">' + 
                   keys.map(k => {
                       const v = window.formatFieldValueHTML(value[k], k);
                       return `<div style="display: flex; gap: 0.5rem;"><span style="font-weight: 600; color: #374151; min-width: fit-content;">${escapeHtml(k)}:</span><span style="color: #6b7280;">${v}</span></div>`;
                   }).join('') + 
                   '</div>';
        }
        // Large object - show as formatted JSON
        return '<pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word;">' + 
               escapeHtml(JSON.stringify(value, null, 2)) + '</pre>';
    }
    
    // Handle strings
    if (typeof value === 'string') {
        // Check for date strings
        const datePattern = /^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}:\d{2})?/;
        if (datePattern.test(value)) {
            try {
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {}
        }
        
        // Check for URLs
        if (value.startsWith('http://') || value.startsWith('https://')) {
            return `<a href="${escapeHtml(value)}" target="_blank" style="color: #007AFF; text-decoration: underline;">${escapeHtml(value)}</a>`;
        }
        
        // Check for email
        if (value.includes('@') && value.includes('.')) {
            return `<a href="mailto:${escapeHtml(value)}" style="color: #007AFF; text-decoration: underline;">${escapeHtml(value)}</a>`;
        }
        
        // Long strings - wrap but don't truncate
        return escapeHtml(value);
    }
    
    // Handle numbers
    if (typeof value === 'number') {
        // Format large numbers with commas
        if (fieldName && (fieldName.toLowerCase().includes('amount') || 
                         fieldName.toLowerCase().includes('balance') || 
                         fieldName.toLowerCase().includes('total') ||
                         fieldName.toLowerCase().includes('price') ||
                         fieldName.toLowerCase().includes('cost'))) {
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        return value.toLocaleString('en-US');
    }
    
    // Handle booleans
    if (typeof value === 'boolean') {
        return value ? '<span style="color: #059669;">‚úì Yes</span>' : '<span style="color: #dc2626;">‚úó No</span>';
    }
    
    return escapeHtml(String(value));
};

// Show entity data modal
window.showEntityDataModal = async function(entityName, records, loading, errorMessage) {
    // Detect dark mode
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const bgColor = isDarkMode ? '#2d2d2d' : '#ffffff';
    const borderColor = isDarkMode ? '#404040' : '#e5e7eb';
    const textColor = isDarkMode ? '#e0e0e0' : '#111827';
    const textSecondary = isDarkMode ? '#b0b0b0' : '#6b7280';
    const buttonBg = isDarkMode ? '#3a3a3a' : '#f3f4f6';
    const buttonBgHover = isDarkMode ? '#4a4a4a' : '#e5e7eb';
    
    // Create or update modal
    let modal = document.getElementById('entity-data-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'entity-data-modal';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;';
        modal.innerHTML = `
            <div style="max-width: 1400px; margin: 2rem auto; background: ${bgColor}; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); min-height: 400px; color: ${textColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid ${borderColor};">
                    <h2 style="margin: 0; color: ${textColor}; font-size: 1.5rem;" id="modal-entity-name"></h2>
                    <button onclick="closeEntityDataModal()" style="background: ${buttonBg}; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 1.25rem; color: ${textSecondary};" onmouseover="this.style.background='${buttonBgHover}'" onmouseout="this.style.background='${buttonBg}'">√ó</button>
                </div>
                <div id="modal-content" style="padding: 1.5rem; overflow-x: auto; color: ${textColor};"></div>
            </div>
        `;
        document.body.appendChild(modal);
    } else {
        // Update existing modal colors if dark mode changed
        const modalContent = modal.querySelector('div[style*="max-width"]');
        if (modalContent) {
            modalContent.style.background = bgColor;
            modalContent.style.color = textColor;
            const header = modalContent.querySelector('div[style*="display: flex"]');
            if (header) {
                header.style.borderBottomColor = borderColor;
            }
            const title = document.getElementById('modal-entity-name');
            if (title) {
                title.style.color = textColor;
            }
            const closeBtn = header?.querySelector('button');
            if (closeBtn) {
                closeBtn.style.background = buttonBg;
                closeBtn.style.color = textSecondary;
            }
        }
    }
    
    // Update modal content
    document.getElementById('modal-entity-name').textContent = entityName;
    const content = document.getElementById('modal-content');
    
    if (loading) {
        const spinnerBorder = isDarkMode ? '#3a3a3a' : '#f3f4f6';
        const loadingTextColor = isDarkMode ? '#b0b0b0' : '#6b7280';
        content.innerHTML = `<div style="text-align: center; padding: 3rem;"><div style="display: inline-block; width: 40px; height: 40px; border: 4px solid ${spinnerBorder}; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div><div style="margin-top: 1rem; color: ${loadingTextColor};">Loading entity data...</div></div><style>@keyframes spin { to { transform: rotate(360deg); } }</style>`;
        modal.style.display = 'block';
        return;
    }
    
    if (errorMessage) {
        const errorColor = isDarkMode ? '#ef4444' : '#dc2626';
        content.innerHTML = `<div style="text-align: center; padding: 3rem; color: ${errorColor};">${escapeHtml(errorMessage)}</div>`;
        modal.style.display = 'block';
        return;
    }
    
    if (!records || records.length === 0) {
        const emptyTextColor = isDarkMode ? '#b0b0b0' : '#6b7280';
        content.innerHTML = `<div style="text-align: center; padding: 3rem; color: ${emptyTextColor};">No records found</div>`;
        modal.style.display = 'block';
        return;
    }
    
    // Collect fields from records
    const allFieldsSet = new Set();
    records.forEach((record) => {
        Object.keys(record).forEach(key => {
            allFieldsSet.add(key);
        });
    });
    
    const allFields = Array.from(allFieldsSet);
    const displayRecords = records;
    
    // Build table
    const tableHeaderBg = isDarkMode ? '#1a1a1a' : '#f9fafb';
    const tableBorder = isDarkMode ? '#404040' : '#e5e7eb';
    const tableText = isDarkMode ? '#e0e0e0' : '#374151';
    const tableTextSecondary = isDarkMode ? '#b0b0b0' : '#6b7280';
    const tableTextPrimary = isDarkMode ? '#e0e0e0' : '#111827';
    
    let html = `<div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">`;
    html += `<div style="color: ${tableTextSecondary}; font-size: 0.875rem;">
        <span style="font-weight: 600; color: ${tableTextPrimary};">${displayRecords.length}</span> record${displayRecords.length !== 1 ? 's' : ''} ‚Ä¢ 
        <span style="font-weight: 600; color: ${tableTextPrimary};">${allFields.length}</span> field${allFields.length !== 1 ? 's' : ''}
    </div>`;
    html += '</div>';
    
    html += `<div style="overflow-x: auto; border: 1px solid ${tableBorder}; border-radius: 8px;">`;
    html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
    
    // Table header
    html += `<thead style="background: ${tableHeaderBg}; border-bottom: 2px solid ${tableBorder}; position: sticky; top: 0; z-index: 10;">`;
    html += '<tr>';
    html += `<th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: ${tableText}; border-right: 1px solid ${tableBorder}; min-width: 80px; max-width: 100px; position: sticky; left: 0; background: ${tableHeaderBg}; z-index: 11;">#</th>`;
    
    allFields.forEach((field) => {
        html += `<th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: ${tableText}; border-right: 1px solid ${tableBorder}; min-width: 150px; max-width: 250px; vertical-align: top; word-break: break-word;">
            ${escapeHtml(field)}
        </th>`;
    });
    
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    // Table body
    const MAX_ROWS = 100;
    const rowsToRender = displayRecords.slice(0, MAX_ROWS);
    rowsToRender.forEach((record, recordIndex) => {
        html += '<tr style="border-bottom: 1px solid ' + tableBorder + ';">';
        
        // Row number
        html += `<td style="padding: 0.75rem 1rem; background: ${tableHeaderBg}; font-weight: 600; color: ${tableTextSecondary}; border-right: 1px solid ${tableBorder}; position: sticky; left: 0; z-index: 10; text-align: center;">${recordIndex + 1}</td>`;
        
        // Fields
        allFields.forEach((field) => {
            let value = record.hasOwnProperty(field) ? record[field] : null;
            
            if (field === 'original_data' && value !== null && value !== undefined) {
                html += `<td style="padding: 0.75rem 1rem; color: ${tableText}; border-right: 1px solid ${tableBorder}; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 0.75rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; max-width: 600px; background: ${isDarkMode ? '#0a0a0a' : '#f9fafb'};">${escapeHtml(JSON.stringify(value, null, 2))}</td>`;
                return;
            }
            
            html += `<td style="padding: 0.75rem 1rem; border-right: 1px solid ${tableBorder}; vertical-align: top; word-wrap: break-word; word-break: break-word; white-space: normal; max-width: 250px; color: ${tableText};">`;
            
            if (value === null) {
                html += 'null';
            } else if (value === undefined) {
                html += 'undefined';
            } else if (typeof value === 'object') {
                html += escapeHtml(JSON.stringify(value));
            } else {
                html += escapeHtml(String(value));
            }
            
            html += '</td>';
        });
        
        html += '</tr>';
    });
    
    if (displayRecords.length > MAX_ROWS) {
        html += `<tr><td colspan="${allFields.length + 1}" style="padding: 1rem; text-align: center; color: ${tableTextSecondary}; background: ${tableHeaderBg};">Showing ${rowsToRender.length} of ${displayRecords.length} records</td></tr>`;
    }
    
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    content.innerHTML = html;
    modal.style.display = 'block';
};

// Close entity data modal
window.closeEntityDataModal = function() {
    const modal = document.getElementById('entity-data-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

// Close modal on outside click
document.addEventListener('click', function(event) {
    const modal = document.getElementById('entity-data-modal');
    if (modal && event.target === modal) {
        closeEntityDataModal();
    }
});

// Show entity data (fetches and displays)
window.showEntityData = async function(entityType, entityName) {
    try {
        console.log('üîç Opening entity data modal for:', entityType, entityName);
        // Show loading modal
        showEntityDataModal(entityName, null, true);
        
        // Fetch entity data
        const response = await fetch(API_URL + '/api/search', {
            method: 'POST',
            headers: {
                'X-Tenant-ID': TENANT_ID,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: '*',
                data_type: entityType,
                limit: 50,
                offset: 0,
                sort_by: 'id',
                sort_order: 'asc',
                routing: 'sanduq_direct'
            })
        });
        
        const data = await response.json();
        
        if (!data.success || !data.data || !data.data.results) {
            showEntityDataModal(entityName, [], false, 'Failed to fetch entity data');
            return;
        }
        
        const records = data.data.results;
        const validRecords = records.filter(record => {
            if (!record.original_data) {
                console.error(`‚ùå Record missing original_data:`, record);
                return false;
            }
            if (!record.data_type) {
                console.error(`‚ùå Record missing data_type:`, record);
                return false;
            }
            return true;
        });
        
        if (validRecords.length > 0) {
            console.log(`‚úÖ Loaded ${validRecords.length} valid ${entityType} records`);
            showEntityDataModal(entityName, validRecords, false);
        } else {
            showEntityDataModal(entityName, [], false, `No ${entityType} data found.`);
        }
    } catch (error) {
        console.error('‚ùå Failed to fetch entity data:', error);
        showEntityDataModal(entityName, [], false, 'Error loading data: ' + error.message);
    }
};
    </script>
</body>
</html>

