<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:9003 http://localhost:9010 http://localhost:8080 https://localhost:9003 https://localhost:9010 https://localhost:8080; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com data:; default-src 'self' http://localhost:9003 http://localhost:9010 http://localhost:8080 https://localhost:9003 https://localhost:9010 https://localhost:8080 data: blob:;">
    <title>Find Data - Muslim Association of Puget Sound</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>" type="image/svg+xml">
    
    <!-- Google Fonts - Poppins (matching main dashboard) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
:root {
    /* Primary brand colors - matching main dashboard */
    --primary-color: #A51D35;
    --primary-hover: #8B1A2E;
    --accent-color: #8B1A2E;
    
    /* Light mode colors */
    --bg-primary: #FFFFFF;
    --bg-secondary: #F9FAFB;
    --bg-tertiary: #F3F4F6;
    --text-primary: #111827;
    --text-secondary: #6B7280;
    --text-tertiary: #9CA3AF;
    --border-color: #E5E7EB;
    --border-hover: #D1D5DB;
    
    /* Font and spacing */
    --font-family: Poppins, sans-serif;
    --border-radius: 8px;
    --spacing: 16px;
}

* {
    box-sizing: border-box;
}

body {
    font-family: Poppins, sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #A51D35 0%, #8B1A2E 50%, #f0f4f8 100%);
    background-attachment: fixed;
    color: #242424;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    line-height: 1.6;
}

.dashboard-grid {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    max-width: 1400px;
    margin: 0 auto;
    padding: 16px;
}

.dashboard-header {
    background: linear-gradient(135deg, #A51D35 0%, #8B1A2E 100%);
    color: #ffffff;
    padding: 40px;
    border-radius: 15px;
    margin-bottom: 40px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    text-align: left;
    position: relative;
    overflow: hidden;
}

.dashboard-header h1 {
    margin: 0;
    font-size: 3em;
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.dashboard-nav {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 20px;
}

.nav-button {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    padding: 12px 24px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
}

.nav-button:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
}

.dashboard-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: calc(16px * 1.5);
}

.entity-types-section {
    margin-bottom: calc(16px * 1.5);
    padding: 24px;
    background: linear-gradient(to bottom, #f9fafb, white);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.entity-types-section h3 {
    font-size: 2em;
    margin-bottom: calc(16px * 0.5);
    color: #1f2937;
    font-weight: 700;
}

.section-description {
    color: #6b7280;
    margin-bottom: 24px;
    font-size: 1rem;
}

.entity-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 24px;
}

.entity-type-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 2px solid #e5e7eb;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    gap: calc(16px * 0.75);
}

.entity-type-card:hover {
    border-color: var(--entity-color, #A51D35);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.entity-icon {
    font-size: 2.5rem;
    margin-bottom: calc(16px * 0.5);
}

.entity-info {
    flex: 1;
}

.entity-name {
    margin: 0 0 calc(16px * 0.5) 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.entity-count {
    font-size: 0.95rem;
    color: #6b7280;
    font-weight: 400;
    margin-left: 0.5rem;
}

.entity-sources {
    font-size: 0.9rem;
    color: #9ca3af;
}

.entity-search-btn {
    background: var(--entity-color, #A51D35);
    color: white;
    border: none;
    border-radius: 8px;
    padding: calc(16px * 0.75) 16px;
    cursor: pointer;
    font-weight: 500;
    transition: opacity 0.2s;
    margin-top: calc(16px * 0.5);
}

.entity-search-btn:hover {
    opacity: 0.9;
}

/* Search Capabilities Section */
.search-capabilities-section {
    margin-bottom: calc(16px * 1.5);
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.search-capabilities-section h3 {
    font-size: 1.5rem;
    margin-bottom: calc(16px * 0.5);
    color: #1f2937;
}


@media (max-width: 768px) {
    .entity-types-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-header h1 {
        font-size: 2em;
    }
}
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <header class="dashboard-header">
            <h1>üîç Find</h1>
        </header>
        
        <main class="dashboard-main">
            <!-- Search Section - PRIMARY ACTION -->
            <section class="search-capabilities-section" style="margin-bottom: calc(16px * 2);">
                <div class="search-input-container" style="display: flex; gap: 0.75rem; margin-bottom: 1rem; align-items: stretch;">
                    <input type="text" id="global-search-input" placeholder="Find across all your data... (e.g., &quot;donations from last month&quot;, &quot;sohail&quot;, &quot;customers&quot;)" style="flex: 1; padding: 1rem 1.25rem; border: 3px solid var(--primary-color); background: var(--bg-primary); color: var(--text-primary); border-radius: 12px; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(165, 29, 53, 0.15); transition: box-shadow 0.2s;" onfocus="this.style.boxShadow='0 6px 16px rgba(165, 29, 53, 0.25)'" onblur="this.style.boxShadow='0 4px 12px rgba(165, 29, 53, 0.15)'">
                    <button id="global-search-btn" style="padding: 1rem 2rem; background: var(--primary-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1.1rem; white-space: nowrap; transition: all 0.2s; box-shadow: 0 4px 12px rgba(165, 29, 53, 0.3);" onmouseover="this.style.background='var(--primary-hover)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(165, 29, 53, 0.4)'" onmouseout="this.style.background='var(--primary-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(165, 29, 53, 0.3)'">Find</button>
                </div>
                <p class="section-description" style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Find donations, contacts, transactions, and more. Try person names, amounts, dates, or entity types.</p>
            </section>
            
            <!-- Search Results Section - Display inline, not modal -->
            <section id="search-results-section" style="display: none; margin-bottom: calc(16px * 2);">
                <div style="background: var(--bg-primary); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.75rem;">
                        <h3 style="margin: 0; color: var(--primary-color); font-weight: 600; font-size: 1.25rem;" id="search-results-title">Find Results</h3>
                        <button id="clear-search-results" style="background: var(--bg-tertiary); color: var(--text-secondary); border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.9rem; transition: background 0.2s;" onmouseover="this.style.background='var(--border-color)'" onmouseout="this.style.background='var(--bg-tertiary)'">Clear</button>
                    </div>
                    <div id="search-results-content" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>
            </section>
            
            <!-- Entity Discovery Section - SECONDARY FEATURE -->
            <section class="entity-types-section" style="margin-top: calc(16px * 2);">
                <h3 style="font-size: 1.5rem; margin-bottom: calc(16px * 0.5); color: var(--text-secondary); font-weight: 500;">üìä Browse by Entity Type</h3>
                <p class="section-description" style="font-size: 0.9rem;">Click any entity type below to browse all records, or use find above to locate specific items:</p>
                <div class="entity-types-grid" id="entity-types-grid">
                    <!-- Entity cards will be dynamically generated from Crema data -->
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="animation: pulse 1.5s ease-in-out infinite;">‚è≥ Loading...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Results Modal -->
    <div id="results-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 2rem auto; background: var(--bg-primary); border-radius: 12px; padding: 2rem; box-shadow: 0 10px 40px rgba(165, 29, 53, 0.3); border-top: 4px solid #A51D35;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(165, 29, 53, 0.1); padding-bottom: 1rem;">
                <h2 id="results-modal-title" style="margin: 0; color: var(--primary-color); font-weight: 600;">Find Results</h2>
                <button id="close-results-modal" style="background: var(--button-primary-bg); color: var(--button-primary-text); border: none; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='var(--primary-hover)'" onmouseout="this.style.background='var(--button-primary-bg)'">&times;</button>
            </div>
            <div id="results-modal-content" style="max-height: 70vh; overflow-y: auto; color: var(--text-primary);"></div>
        </div>
    </div>

    <script>
/**
 * Find Data Solution - Default Reference Implementation
 * 
 * Architecture:
 *   Frontend (this file) ‚Üí Kandaq API (port 9010) ‚Üí Sanduq (port 9003)
 * 
 * Backend Requirements:
 *   - Registry (port 9005) - REQUIRED: Single source of truth for service discovery
 *   - Kandaq API (port 9010) - Discovers Sanduq URL from Registry
 *   - Sanduq (port 9003) - Must be registered in Registry
 *   - PostgreSQL - For Crema entity counts
 * 
 * Service Startup Order:
 *   1. Start Registry (port 9005)
 *   2. Start Sanduq (port 9003) - registers with Registry
 *   3. Start Kandaq API (port 9010) - discovers Sanduq from Registry
 * 
 * This frontend calls Kandaq API endpoints:
 *   - GET /api/crema - Entity discovery
 *   - POST /api/tenants/{tenant_id}/find - Find queries
 * 
 * See: docs/business/SEARCH_SOLUTION_MINIMAL_SETUP.md for setup guide
 */

// Auto-generated JavaScript for maps
const TENANT_ID = "maps";
const BUSINESS_TYPE = "non_profit_organization";
const API_URL = "http://localhost:9010";

// Crema data (discovered entities and categories)
let CREMA_DATA = null;

// Fetch Crema data for latest discovery (via Kandaq API, not Sanduq directly)
async function fetchCremaData() {
    try {
        // Add timeout to prevent hanging on slow Crema requests
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch(API_URL + '/api/crema', {
            headers: {
                'X-Tenant-ID': TENANT_ID,
                'Content-Type': 'application/json'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const data = await response.json();
        if (data.success && data.data) {
            CREMA_DATA = data.data;
            // API returns data_types, not entityTypes
            // Also extract entities from sources array
            const dataTypes = CREMA_DATA.data_types || [];
            const sourcesEntities = (CREMA_DATA.sources || []).flatMap(s => s.entities || []);
            // Combine both sources - prefer data_types as primary source
            const allEntities = dataTypes.length > 0 ? dataTypes : sourcesEntities;
            console.log('üìä Found', allEntities.length, 'entity types from Crema');
            console.log('üìä Sample entities:', allEntities.slice(0, 3).map(e => ({
                key: e.data_type || e.key,
                count: e.count,
                name: e.name || e.display_name
            })));
            updateEntityCounts(allEntities);
        } else {
            console.error('Failed to fetch Crema data:', data);
            showError('Failed to load search data');
        }
    } catch (error) {
        console.error('Error fetching Crema data:', error);
        showError('Error loading search data: ' + error.message);
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Map SF Symbols to Font Awesome icons
function mapSFIconToFontAwesome(sfIcon) {
    if (!sfIcon) return 'fa-file';
    
    const iconMap = {
        'person.2': 'fa-users',
        'person.3': 'fa-users',
        'person.circle': 'fa-user-circle',
        'person.badge.plus': 'fa-user-plus',
        'person.crop.circle': 'fa-user-circle',
        'person.circle.fill': 'fa-user-circle',
        'doc': 'fa-file',
        'doc.text': 'fa-file-alt',
        'doc.on.doc': 'fa-copy',
        'doc.text.fill': 'fa-file-alt',
        'doc.text.magnifyingglass': 'fa-file-search',
        'doc.richtext': 'fa-file-alt',
        'heart': 'fa-heart',
        'creditcard': 'fa-credit-card',
        'dollarsign.circle': 'fa-dollar-sign',
        'dollarsign.square': 'fa-dollar-sign',
        'cart': 'fa-shopping-cart',
        'book': 'fa-book',
        'cube': 'fa-cube',
        'cube.box': 'fa-box',
        'folder': 'fa-folder',
        'clock': 'fa-clock',
        'gear': 'fa-cog',
        'list.bullet': 'fa-list',
        'square.and.pencil': 'fa-pencil-square',
        'truck.box': 'fa-truck',
        'star.bubble': 'fa-star',
        'star': 'fa-star',
        'photo': 'fa-image',
        'video': 'fa-video',
        'music.note': 'fa-music',
        'archivebox': 'fa-archive',
    };
    
    if (iconMap[sfIcon]) {
        return iconMap[sfIcon];
    }
    
    const baseIcon = sfIcon.split('.')[0];
    if (iconMap[baseIcon]) {
        return iconMap[baseIcon];
    }
    
    return 'fa-file';
}

// Error handling
function showError(message) {
    const entityGrid = document.getElementById('entity-types-grid');
    if (entityGrid) {
        entityGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444; background: #fee; border: 1px solid #fcc; border-radius: 8px;"><strong>‚ö†Ô∏è Error:</strong> ' + escapeHtml(message) + '</div>';
    }
}

// Generate entity cards dynamically from Crema data
function generateEntityCardsFromCrema(entityTypes) {
    if (!entityTypes || entityTypes.length === 0) {
        console.log('‚ö†Ô∏è No entity types from Crema to display');
        const entityGrid = document.getElementById('entity-types-grid');
        if (entityGrid) {
            entityGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No business entities found</div>';
        }
        return;
    }
    
    const entityGrid = document.getElementById('entity-types-grid');
    if (!entityGrid) {
        console.error('‚ùå Could not find entity-types-grid element');
        return;
    }
    
    entityGrid.innerHTML = '';
    
    const businessEntityTypes = entityTypes.filter(et => {
        const count = et.count || 0;
        // Handle both data_type and key fields
        const key = ((et.data_type || et.key || '').toLowerCase());
        // Include file-based entities: image, images, video, videos, audio, document, documents, archive, archives
        // Only exclude generic 'text', 'file', 'files', 'binary' types (not specific file types)
        const excludedTypes = ['text', 'file', 'files', 'binary'];
        const fileBasedTypes = ['image', 'images', 'video', 'videos', 'audio', 'document', 'documents', 'archive', 'archives'];
        // Include if count > 0 AND (not in excluded types OR is a file-based type)
        return count > 0 && (!excludedTypes.includes(key) || fileBasedTypes.includes(key));
    });
    
    console.log('üîÑ Generating ' + businessEntityTypes.length + ' entity cards from Crema data');
    
    businessEntityTypes.forEach(entityType => {
        // Handle both data_types format (has data_type field) and sources.entities format (has key field)
        const key = entityType.data_type || entityType.key || '';
        const name = entityType.name || entityType.display_name || key;
        const count = entityType.count || 0;
        const color = entityType.color || '#A51D35'; // Use MAPS brand color as default
        const sources = entityType.sources || [];
        
        // Determine if this is a file-based entity
        const keyLower = key.toLowerCase();
        const isFileBased = ['image', 'images', 'video', 'videos', 'audio', 'document', 'documents', 'archive', 'archives'].includes(keyLower);
        
        // Get icon for file-based entities
        let icon = '';
        if (isFileBased) {
            if (keyLower.includes('image')) {
                icon = '<i class="fas fa-image" style="font-size: 1.5rem; color: #A51D35; margin-right: 0.5rem;"></i>';
            } else if (keyLower.includes('video')) {
                icon = '<i class="fas fa-video" style="font-size: 1.5rem; color: #A51D35; margin-right: 0.5rem;"></i>';
            } else if (keyLower.includes('audio')) {
                icon = '<i class="fas fa-music" style="font-size: 1.5rem; color: #A51D35; margin-right: 0.5rem;"></i>';
            } else if (keyLower.includes('document')) {
                icon = '<i class="fas fa-file-alt" style="font-size: 1.5rem; color: #A51D35; margin-right: 0.5rem;"></i>';
            } else if (keyLower.includes('archive')) {
                icon = '<i class="fas fa-archive" style="font-size: 1.5rem; color: #A51D35; margin-right: 0.5rem;"></i>';
            }
        }
        
        const sourcesText = sources.length > 0 
            ? sources.map(s => s.system).join(', ')
            : 'unknown';
        
        const card = document.createElement('div');
        card.className = 'entity-type-card';
        card.setAttribute('style', `--entity-color: ${color};`);
        
        card.innerHTML = 
            '<div class="entity-info">' +
                '<h4 class="entity-name">' + icon + '<span class="entity-name-text">' + escapeHtml(name) + '</span><span class="entity-count">' + count.toLocaleString() + '</span></h4>' +
                '<div class="entity-sources">From: ' + escapeHtml(sourcesText) + '</div>' +
            '</div>';
        
        card.style.cursor = 'pointer';
        card.setAttribute('data-entity-type', key);
        card.setAttribute('data-entity-name', name);
        
        // Add click handler to open entity data modal directly
        card.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (typeof window.showEntityData === 'function') {
                window.showEntityData(key, name);
            } else {
                console.error('showEntityData function not available');
            }
        });
        
        entityGrid.appendChild(card);
    });
    
    console.log(`‚úÖ Generated ${businessEntityTypes.length} entity cards`);
}

// Update entity counts from Crema
function updateEntityCounts(entityTypes) {
    generateEntityCardsFromCrema(entityTypes);
}

// Global AbortController for search cancellation
let currentSearchController = null;

// Performance optimizations: Request caching and deduplication
let searchCache = new Map(); // Cache recent search results (query -> {results, timestamp})
const CACHE_TTL = 30000; // 30 seconds cache TTL
let pendingSearches = new Set(); // Track pending searches to prevent duplicates

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Loading search data for tenant:', TENANT_ID);
    await fetchCremaData();
    
    // Setup search functionality
    const searchInput = document.getElementById('global-search-input');
    if (searchInput) {
        // Enter key triggers search
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchBtn = document.getElementById('global-search-btn');
                if (searchBtn) {
                    searchBtn.click();
                }
            }
        });
    }
    
    // Setup search button click handler
    const searchBtn = document.getElementById('global-search-btn');
    if (searchBtn) {
        searchBtn.addEventListener('click', async () => {
            const query = searchInput?.value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            // PERFORMANCE: Check cache first
            const cacheKey = query.toLowerCase();
            const cached = searchCache.get(cacheKey);
            if (cached && (Date.now() - cached.timestamp) < CACHE_TTL) {
                console.log('‚ö° Using cached search results for:', query);
                    showSearchResultsInline('Find Results: "' + query + '"', cached.results);
                return;
            }
            
            // PERFORMANCE: Prevent duplicate requests
            if (pendingSearches.has(cacheKey)) {
                console.log('‚è∏Ô∏è Search already in progress for:', query);
                return;
            }
            
            // Cancel previous search if it's still running
            if (currentSearchController) {
                console.log('üõë Cancelling previous search');
                currentSearchController.abort();
            }
            
            // Create new AbortController for this search
            currentSearchController = new AbortController();
            const signal = currentSearchController.signal;
            
            // Store reference to this search's button state
            const thisSearchBtn = searchBtn;
            const originalBtnText = searchBtn.textContent;
            
            // Mark search as pending
            pendingSearches.add(cacheKey);
            
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';
            
            try {
                const results = await searchGlobal(query, signal);
                // Only show results if this search wasn't cancelled
                if (!signal.aborted) {
                    // PERFORMANCE: Cache results
                    searchCache.set(cacheKey, {
                        results: results,
                        timestamp: Date.now()
                    });
                    // Limit cache size (keep last 20 searches)
                    if (searchCache.size > 20) {
                        const firstKey = searchCache.keys().next().value;
                        searchCache.delete(firstKey);
                    }
                    
                    showSearchResultsInline('Find Results: "' + query + '"', results);
                }
            } catch (error) {
                // Ignore AbortError (search was cancelled) - don't show error
                if (error.name === 'AbortError') {
                    console.log('üõë Search was cancelled (new search started)');
                    return; // Exit early - new search will handle UI
                }
                console.error('‚ùå Search error:', error);
                showSearchResultsInline('Find Error', []);
                const contentEl = document.getElementById('search-results-content');
                if (contentEl) {
                    contentEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;"><strong>‚ö†Ô∏è Error:</strong> ' + escapeHtml(error.message) + '</div>';
                }
            } finally {
                // Remove from pending set
                pendingSearches.delete(cacheKey);
                
                // Always re-enable button (unless it was cancelled, in which case new search handles it)
                if (!signal.aborted) {
                    thisSearchBtn.disabled = false;
                    thisSearchBtn.textContent = originalBtnText;
                }
            }
        });
    }
    
    // Setup clear search results button
    const clearBtn = document.getElementById('clear-search-results');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            const resultsSection = document.getElementById('search-results-section');
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            if (searchInput) {
                searchInput.value = '';
            }
        });
    }
    
    // Setup modal close handler
    const closeBtn = document.getElementById('close-results-modal');
    const modal = document.getElementById('results-modal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeResultsModal);
    }
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeResultsModal();
            }
        });
    }
});

// Global search function
async function searchGlobal(query, signal = null) {
    try {
        console.log('üîç Global search:', query);
        
        // AUTO-DETECTION: Detect query patterns and suggest data_type filter
        let dataType = null;
        const queryLower = query.toLowerCase().trim();
        const queryTrimmed = query.trim();
        
        // Pattern 0: Person names (2-3 words, no business keywords) - CHECK FIRST before keyword detection
        // This handles both capitalized ("John Smith") and lowercase ("sohail") names
        const businessKeywords = ['donation', 'donor', 'invoice', 'bill', 'payment', 'expense', 'revenue', 'customer', 'vendor', 'contact', 'transaction'];
        const hasBusinessKeyword = businessKeywords.some(keyword => queryLower.includes(keyword));
        
        // Donation keywords for auto-detection
        const donationKeywords = ['donation', 'donor', 'contribution', 'gift', 'pledge', 'fundraising', 'fundraiser'];
        
        // Person name pattern: 1-3 words, mostly letters (allow some special chars like hyphens)
        // Exclude queries that are clearly not names (numbers, very long, business keywords)
        const isLikelyPersonName = !hasBusinessKeyword && 
                                   queryTrimmed.length >= 2 && 
                                   queryTrimmed.length <= 50 &&
                                   /^[a-zA-Z\s\-']+$/.test(queryTrimmed) &&
                                   queryTrimmed.split(/\s+/).length <= 3;
        
        if (isLikelyPersonName) {
            // For person names, search in contacts first (most general), then customers/vendors
            // Use 'contact' as primary since it's the most general person entity type
            dataType = 'contact';
            console.log('üîç Auto-detection: Person name detected ‚Üí using data_type: contact');
        }
        
        // Pattern 1: Donation keywords
        else if (donationKeywords.some(keyword => queryLower.includes(keyword))) {
            dataType = 'donation';
            console.log('üîç Auto-detection: Donation keyword detected ‚Üí using data_type: donation');
        }
        
        // Pattern 2: Invoice/Bill keywords
        else if (queryLower.includes('invoice')) {
            dataType = 'qb_invoices';
            console.log('üîç Auto-detection: Invoice keyword detected ‚Üí using data_type: qb_invoices');
        }
        else if (queryLower.includes('bill') || queryLower.includes('expense')) {
            dataType = 'qb_bills';
            console.log('üîç Auto-detection: Bill/expense keyword detected ‚Üí using data_type: qb_bills');
        }
        
        // Pattern 3: Customer/Vendor/Contact keywords
        else if (queryLower.includes('customer') || queryLower.includes('client')) {
            dataType = 'qb_customers';
            console.log('üîç Auto-detection: Customer keyword detected ‚Üí using data_type: qb_customers');
        }
        else if (queryLower.includes('vendor') || queryLower.includes('supplier')) {
            dataType = 'qb_vendors';
            console.log('üîç Auto-detection: Vendor keyword detected ‚Üí using data_type: qb_vendors');
        }
        else if (queryLower.includes('contact')) {
            dataType = 'contact';
            console.log('üîç Auto-detection: Contact keyword detected ‚Üí using data_type: contact');
        }
        
        // Pattern 4: Transaction keywords
        else if (queryLower.includes('transaction') || queryLower.includes('payment')) {
            dataType = 'transaction';
            console.log('üîç Auto-detection: Transaction keyword detected ‚Üí using data_type: transaction');
        }
        
        // Build request body with optional data_type filter
        // PERFORMANCE: Use smaller limit for faster initial results
        const requestBody = {
            query: query,
            limit: 10,  // Reduced to 10 for faster initial results (can load more if needed)
            offset: 0
        };
        
        // Add data_type filter if detected (improves performance significantly)
        if (dataType) {
            requestBody.data_type = dataType;
        }
        
        // Use the new Universal Search endpoint with AbortSignal for cancellation
        const fetchOptions = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        };
        
        // Add signal if provided (for cancellation)
        if (signal) {
            fetchOptions.signal = signal;
        }
        
        const response = await fetch(API_URL + '/api/tenants/' + TENANT_ID + '/find', fetchOptions);
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Search failed:', response.status, response.statusText, errorText);
            
            // Parse error message for better user feedback
            let errorMessage = 'Search failed';
            try {
                const errorData = JSON.parse(errorText);
                if (errorData.error && errorData.error.includes('Connection refused')) {
                    errorMessage = 'Search service is temporarily unavailable. Please try again in a moment.';
                } else if (errorData.error) {
                    errorMessage = errorData.error;
                }
            } catch (e) {
                // If parsing fails, use generic message
            }
            
            // Show error to user (inline)
            showSearchResultsInline('Search Error', []);
            const contentEl = document.getElementById('search-results-content');
            if (contentEl) {
                contentEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;"><strong>‚ö†Ô∏è Error:</strong> ' + escapeHtml(errorMessage) + '<br><br><small style="color: #6b7280;">The search service may be starting up. Please try again in a few seconds.</small></div>';
            }
            return [];
        }
        const data = await response.json();
        console.log('‚úÖ Search response:', {
            success: data.success,
            results_count: data.data?.results?.length || data.results?.length || 0,
            total: data.data?.total || data.total || 0
        });
        // Handle Universal Search endpoint response format: {success: true, data: {results: [...], total: N}}
        if (data.success) {
            const results = data.data?.results || data.results || [];
            console.log('üìä Find results:', results.length, 'results');
            if (results.length > 0) {
                console.log('üìã First result fields:', Object.keys(results[0]));
                console.log('üìã Sample result:', {
                    title: results[0].title,
                    description: results[0].description,
                    date: results[0].date,
                    amount: results[0].amount,
                    data_type: results[0].data_type || results[0].dataType
                });
            }
            return results;
        }
        return [];
    } catch (error) {
        // Handle AbortError (search was cancelled) - don't log as error
        if (error.name === 'AbortError') {
            console.log('üõë Search cancelled');
            throw error; // Re-throw to let caller know it was cancelled
        }
        console.error('‚ö†Ô∏è Find error:', error);
        throw error; // Re-throw other errors
    }
}

// Show search results inline (primary for search solution)
function showSearchResultsInline(title, results) {
    const resultsSection = document.getElementById('search-results-section');
    const titleEl = document.getElementById('search-results-title');
    const contentEl = document.getElementById('search-results-content');
    
    if (!resultsSection || !titleEl || !contentEl) return;
    
    // Show the results section
    resultsSection.style.display = 'block';
    
    // Scroll to results
    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    titleEl.textContent = title + (results.length > 0 ? ` (${results.length} found)` : '');
    
    if (results.length === 0) {
        contentEl.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No results found. Try different search terms or browse by entity type below.</p>';
    } else {
        // Extract search query from title for highlighting
        const searchQueryMatch = title.match(/\"([^\"]+)\"/);
        const searchQuery = searchQueryMatch ? searchQueryMatch[1].toLowerCase() : '';
        
        // Helper function to highlight search terms in text
        function highlightText(text, query) {
            if (!query || !text) return escapeHtml(String(text));
            const escapedText = escapeHtml(String(text));
            const regex = new RegExp('(' + escapeHtml(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return escapedText.replace(regex, '<mark style="background: #fef08a; padding: 0.1em 0.2em; border-radius: 3px; font-weight: 600;">$1</mark>');
        }
        
        // Enhanced results display - show formatted details for each result
        let html = '<div style="display: grid; gap: 1rem;">';
        results.forEach((result, index) => {
            // Use formatted fields from API (title, description, date, etc.)
            const title = result.title || result.id || `Result ${index + 1}`;
            const displayType = result.display_type || result.data_type || 'unknown';
            const description = result.description || '';
            const date = result.date || '';
            const dueDate = result.due_date || '';
            const amount = result.amount;
            const balance = result.balance;
            const vendor = result.vendor || result.customer || result.donor || '';
            const account = result.account || '';
            const docNumber = result.doc_number || result.invoice_number || result.receipt_number || result.reference || '';
            const lineItemsCount = result.line_items_count || 0;
            const status = result.status || '';
            const sourceSystem = result.source_system || '';
            
            // Fully adaptable to Crema - display all available fields dynamically
            // No hardcoded field assumptions - works for any data type
            
            html += '<div style="background: white; border: 1px solid rgba(165, 29, 53, 0.2); border-radius: 8px; padding: 1.25rem; box-shadow: 0 2px 4px rgba(165, 29, 53, 0.1);">';
            
            // Title and type with source system badge
            html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">';
            html += '<div style="flex: 1;">';
            html += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">';
            html += '<div style="font-weight: 700; font-size: 1.15rem; color: #A51D35;">' + highlightText(title, searchQuery) + '</div>';
            if (sourceSystem) {
                html += '<span style="background: #e5e7eb; color: #6b7280; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; text-transform: capitalize; font-weight: 500;">' + escapeHtml(sourceSystem) + '</span>';
            }
            html += '</div>';
            html += '<div style="font-size: 0.85rem; color: #6b7280; text-transform: capitalize;">' + escapeHtml(displayType);
            if (status) {
                html += ' <span style="color: ' + (status.toLowerCase().includes('paid') || status.toLowerCase().includes('complete') ? '#059669' : '#dc2626') + ';">‚Ä¢ ' + escapeHtml(status) + '</span>';
            }
            html += '</div>';
            html += '</div>';
            if (amount !== undefined && amount !== null) {
                html += '<div style="font-weight: 700; font-size: 1.1rem; color: #059669; white-space: nowrap; margin-left: 1rem;">$' + parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
            }
            html += '</div>';
            
            // Description
            if (description) {
                html += '<div style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.75rem; line-height: 1.5;">' + highlightText(description, searchQuery) + '</div>';
            }
            
            // Details grid - dynamically display all available fields from result
            // Fields are already extracted by backend with fallbacks (title has fallback on line 667)
            // Fail fast if result structure is invalid
            if (typeof result !== 'object' || result === null) {
                console.error('Invalid search result structure:', result);
                html += '<div style="color: #dc2626; padding: 1rem;">Error: Invalid search result structure</div>';
                html += '</div>';
                resultDiv.innerHTML = html;
                container.appendChild(resultDiv);
                return; // Use return instead of continue in forEach
            }
            
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">';
            
            // System fields to skip (already displayed or not useful)
            const skipFields = ['title', 'description', 'display_type', 'data_type', 'source_system', 'id', '_id', 'original_data'];
            
            for (const [key, value] of Object.entries(result)) {
                // Skip system fields and already displayed fields
                if (skipFields.includes(key) || value === null || value === undefined || value === '') {
                    continue;
                }
                
                // Format field name for display
                const fieldLabel = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                // Special handling for common field types
                let displayValue = value;
                let isLink = false;
                let linkHref = '';
                
                // Email fields - make clickable
                if (key.toLowerCase().includes('email') && typeof value === 'string' && value.includes('@')) {
                    isLink = true;
                    linkHref = 'mailto:' + escapeHtml(value);
                }
                // Phone fields - make clickable
                else if (key.toLowerCase().includes('phone') && typeof value === 'string') {
                    isLink = true;
                    linkHref = 'tel:' + value.replace(/\D/g, '');
                }
                // Amount/money fields - format as currency
                else if ((key.toLowerCase().includes('amount') || key.toLowerCase().includes('total') || key.toLowerCase().includes('balance') || key.toLowerCase().includes('price')) && typeof value === 'number') {
                    displayValue = '$' + parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
                // Date fields - keep as-is (already formatted)
                else if (key.toLowerCase().includes('date') && typeof value === 'string') {
                    displayValue = value;
                }
                // Reference/document numbers - use monospace
                else if ((key.toLowerCase().includes('reference') || key.toLowerCase().includes('doc_number') || key.toLowerCase().includes('invoice_number')) && typeof value === 'string') {
                    displayValue = '<span style="font-family: monospace;">' + escapeHtml(String(value)) + '</span>';
                }
                else {
                    displayValue = escapeHtml(String(value));
                }
                
                // Render field
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">' + escapeHtml(fieldLabel) + ':</strong><br>';
                if (isLink) {
                    html += '<a href="' + linkHref + '" style="color: #2563eb; text-decoration: none;">' + displayValue + '</a>';
                } else {
                    html += '<span style="color: var(--text-primary);">' + displayValue + '</span>';
                }
                html += '</div>';
            }
            
            html += '</div>'; // End details grid
            
            html += '</div>'; // End result card
        });
        html += '</div>';
        
        html += '<div style="text-align: center; color: #6b7280; margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.85rem;">';
        html += '<strong>Total:</strong> ' + results.length + ' result' + (results.length !== 1 ? 's' : '');
        html += '</div>';
        contentEl.innerHTML = html;
    }
}

// Results modal functions (kept for entity browsing)
function showResultsModal(title, results) {
    const modal = document.getElementById('results-modal');
    const titleEl = document.getElementById('results-modal-title');
    const contentEl = document.getElementById('results-modal-content');
    
    if (!modal || !titleEl || !contentEl) return;
    
    // Show the modal
    modal.style.display = 'block';
    
    titleEl.textContent = title;
    
    if (results.length === 0) {
        contentEl.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No results found.</p>';
    } else {
        // Extract search query from title for highlighting
        const searchQueryMatch = title.match(/\"([^\"]+)\"/);
        const searchQuery = searchQueryMatch ? searchQueryMatch[1].toLowerCase() : '';
        
        // Helper function to highlight search terms in text
        function highlightText(text, query) {
            if (!query || !text) return escapeHtml(String(text));
            const escapedText = escapeHtml(String(text));
            const regex = new RegExp('(' + escapeHtml(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return escapedText.replace(regex, '<mark style="background: #fef08a; padding: 0.1em 0.2em; border-radius: 3px; font-weight: 600;">$1</mark>');
        }
        
        // Enhanced results display - show formatted details for each result
        let html = '<div style="display: grid; gap: 1rem;">';
        results.forEach((result, index) => {
            // Use formatted fields from API (title, description, date, etc.)
            const title = result.title || result.id || `Result ${index + 1}`;
            const displayType = result.display_type || result.data_type || 'unknown';
            const description = result.description || '';
            const date = result.date || '';
            const dueDate = result.due_date || '';
            const amount = result.amount;
            const balance = result.balance;
            const vendor = result.vendor || result.customer || result.donor || '';
            const account = result.account || '';
            const docNumber = result.doc_number || result.invoice_number || result.receipt_number || '';
            const lineItemsCount = result.line_items_count || 0;
            
            html += '<div style="background: white; border: 1px solid rgba(165, 29, 53, 0.2); border-radius: 8px; padding: 1.25rem; box-shadow: 0 2px 4px rgba(165, 29, 53, 0.1);">';
            
            // Title and type
            html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">';
            html += '<div style="flex: 1;">';
            html += '<div style="font-weight: 700; font-size: 1.15rem; color: #A51D35; margin-bottom: 0.25rem;">' + highlightText(title, searchQuery) + '</div>';
            html += '<div style="font-size: 0.85rem; color: #6b7280; text-transform: capitalize;">' + escapeHtml(displayType) + '</div>';
            html += '</div>';
            if (amount !== undefined && amount !== null) {
                html += '<div style="font-weight: 700; font-size: 1.1rem; color: #059669; white-space: nowrap; margin-left: 1rem;">$' + parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
            }
            html += '</div>';
            
            // Description
            if (description) {
                html += '<div style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.75rem; line-height: 1.5;">' + highlightText(description, searchQuery) + '</div>';
            }
            
            // Details grid
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">';
            
            // Date
            if (date) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Date:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(date) + '</span></div>';
            }
            
            // Due Date
            if (dueDate) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Due Date:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(dueDate) + '</span></div>';
            }
            
            // Vendor/Customer/Donor
            if (vendor) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">' + (result.vendor ? 'Vendor' : result.customer ? 'Customer' : 'Donor') + ':</strong><br><span style="color: var(--text-primary);">' + escapeHtml(vendor) + '</span></div>';
            }
            
            // Account
            if (account) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Account:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(account) + '</span></div>';
            }
            
            // Document Number
            if (docNumber) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Document #:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(docNumber) + '</span></div>';
            }
            
            // Balance (if different from amount)
            if (balance !== undefined && balance !== null && balance !== amount) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Balance:</strong><br><span style="color: ' + (parseFloat(balance) > 0 ? '#dc2626' : '#059669') + ';">$' + parseFloat(balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</span></div>';
            }
            
            // Line Items Count
            if (lineItemsCount > 0) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Line Items:</strong><br><span style="color: var(--text-primary);">' + lineItemsCount + '</span></div>';
            }
            
            html += '</div>'; // End details grid
            
            html += '</div>'; // End result card
        });
        html += '</div>';
        
        html += '<div style="text-align: center; color: #6b7280; margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.85rem;">';
        html += '<strong>Total:</strong> ' + results.length + ' result' + (results.length !== 1 ? 's' : '');
        html += '</div>';
        contentEl.innerHTML = html;
    }
}

// Results modal functions (kept for entity browsing)
function showResultsModal(title, results) {
    const modal = document.getElementById('results-modal');
    const titleEl = document.getElementById('results-modal-title');
    const contentEl = document.getElementById('results-modal-content');
    
    if (!modal || !titleEl || !contentEl) return;
    
    // Show the modal
    modal.style.display = 'block';
    
    titleEl.textContent = title;
    
    if (results.length === 0) {
        contentEl.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No results found.</p>';
    } else {
        // Extract search query from title for highlighting
        const searchQueryMatch = title.match(/\"([^\"]+)\"/);
        const searchQuery = searchQueryMatch ? searchQueryMatch[1].toLowerCase() : '';
        
        // Helper function to highlight search terms in text
        function highlightText(text, query) {
            if (!query || !text) return escapeHtml(String(text));
            const escapedText = escapeHtml(String(text));
            const regex = new RegExp('(' + escapeHtml(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return escapedText.replace(regex, '<mark style="background: #fef08a; padding: 0.1em 0.2em; border-radius: 3px; font-weight: 600;">$1</mark>');
        }
        
        // Enhanced results display - show formatted details for each result
        let html = '<div style="display: grid; gap: 1rem;">';
        results.forEach((result, index) => {
            // Use formatted fields from API (title, description, date, etc.)
            const title = result.title || result.id || `Result ${index + 1}`;
            const displayType = result.display_type || result.data_type || 'unknown';
            const description = result.description || '';
            const date = result.date || '';
            const dueDate = result.due_date || '';
            const amount = result.amount;
            const balance = result.balance;
            const vendor = result.vendor || result.customer || result.donor || '';
            const account = result.account || '';
            const docNumber = result.doc_number || result.invoice_number || result.receipt_number || '';
            const lineItemsCount = result.line_items_count || 0;
            
            html += '<div style="background: white; border: 1px solid rgba(165, 29, 53, 0.2); border-radius: 8px; padding: 1.25rem; box-shadow: 0 2px 4px rgba(165, 29, 53, 0.1);">';
            
            // Title and type
            html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">';
            html += '<div style="flex: 1;">';
            html += '<div style="font-weight: 700; font-size: 1.15rem; color: #A51D35; margin-bottom: 0.25rem;">' + highlightText(title, searchQuery) + '</div>';
            html += '<div style="font-size: 0.85rem; color: #6b7280; text-transform: capitalize;">' + escapeHtml(displayType) + '</div>';
            html += '</div>';
            if (amount !== undefined && amount !== null) {
                html += '<div style="font-weight: 700; font-size: 1.1rem; color: #059669; white-space: nowrap; margin-left: 1rem;">$' + parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
            }
            html += '</div>';
            
            // Description
            if (description) {
                html += '<div style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.75rem; line-height: 1.5;">' + highlightText(description, searchQuery) + '</div>';
            }
            
            // Details grid
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">';
            
            // Date
            if (date) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Date:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(date) + '</span></div>';
            }
            
            // Due Date
            if (dueDate) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Due Date:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(dueDate) + '</span></div>';
            }
            
            // Vendor/Customer/Donor
            if (vendor) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">' + (result.vendor ? 'Vendor' : result.customer ? 'Customer' : 'Donor') + ':</strong><br><span style="color: var(--text-primary);">' + escapeHtml(vendor) + '</span></div>';
            }
            
            // Account
            if (account) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Account:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(account) + '</span></div>';
            }
            
            // Document Number
            if (docNumber) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Document #:</strong><br><span style="color: var(--text-primary);">' + escapeHtml(docNumber) + '</span></div>';
            }
            
            // Balance (if different from amount)
            if (balance !== undefined && balance !== null && balance !== amount) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Balance:</strong><br><span style="color: ' + (parseFloat(balance) > 0 ? '#dc2626' : '#059669') + ';">$' + parseFloat(balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</span></div>';
            }
            
            // Line Items Count
            if (lineItemsCount > 0) {
                html += '<div><strong style="color: #6b7280; font-size: 0.85rem;">Line Items:</strong><br><span style="color: var(--text-primary);">' + lineItemsCount + '</span></div>';
            }
            
            html += '</div>'; // End details grid
            
            html += '</div>'; // End result card
        });
        html += '</div>';
        
        html += '<div style="text-align: center; color: #6b7280; margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.85rem;">';
        html += '<strong>Total:</strong> ' + results.length + ' result' + (results.length !== 1 ? 's' : '');
        html += '</div>';
        contentEl.innerHTML = html;
    }
    
    modal.style.display = 'block';
}

function closeResultsModal() {
    const modal = document.getElementById('results-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Function to open file in OS default viewer/player
function openFile(fileId, filePath, mimeType) {
    if (!fileId || fileId === '') {
        console.error('File ID not available. File data:', { fileId, filePath, mimeType });
        alert('File ID not available. Cannot open file without proper identifier.\n\nFile Path: ' + (filePath || 'N/A'));
        return;
    }
    
    // Construct file URL using Kandaq API content endpoint
    const fileUrl = API_URL + '/api/tenants/' + TENANT_ID + '/content/' + encodeURIComponent(fileId);
    
    // Open in new tab
    window.open(fileUrl, '_blank');
}

// Format field value for better readability (HTML version)
window.formatFieldValueHTML = function(value, fieldName) {
    if (value === null || value === undefined || value === '') {
        return '<span style="color: #9ca3af; font-style: italic;">(empty)</span>';
    }
    
    // Handle objects/arrays
    if (typeof value === 'object') {
        if (Array.isArray(value)) {
            if (value.length === 0) return '<span style="color: #9ca3af;">(empty array)</span>';
            return value.map(item => {
                if (typeof item === 'object') {
                    return JSON.stringify(item, null, 2);
                }
                return String(item);
            }).join(', ');
        }
        // Object - try to format nicely
        const keys = Object.keys(value);
        if (keys.length === 0) return '<span style="color: #9ca3af;">(empty object)</span>';
        if (keys.length <= 3) {
            // Small object - show as formatted name-value pairs
            return '<div style="display: flex; flex-direction: column; gap: 0.25rem;">' + 
                   keys.map(k => {
                       const v = window.formatFieldValueHTML(value[k], k);
                       return `<div style="display: flex; gap: 0.5rem;"><span style="font-weight: 600; color: #374151; min-width: fit-content;">${escapeHtml(k)}:</span><span style="color: #6b7280;">${v}</span></div>`;
                   }).join('') + 
                   '</div>';
        }
        // Large object - show as formatted JSON
        return '<pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word;">' + 
               escapeHtml(JSON.stringify(value, null, 2)) + '</pre>';
    }
    
    // Handle strings
    if (typeof value === 'string') {
        // Check for date strings
        const datePattern = /^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}:\d{2})?/;
        if (datePattern.test(value)) {
            try {
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {}
        }
        
        // Check for URLs
        if (value.startsWith('http://') || value.startsWith('https://')) {
            return `<a href="${escapeHtml(value)}" target="_blank" style="color: #007AFF; text-decoration: underline;">${escapeHtml(value)}</a>`;
        }
        
        // Check for email
        if (value.includes('@') && value.includes('.')) {
            return `<a href="mailto:${escapeHtml(value)}" style="color: #007AFF; text-decoration: underline;">${escapeHtml(value)}</a>`;
        }
        
        // Long strings - wrap but don't truncate
        return escapeHtml(value);
    }
    
    // Handle numbers
    if (typeof value === 'number') {
        // Format large numbers with commas
        if (fieldName && (fieldName.toLowerCase().includes('amount') || 
                         fieldName.toLowerCase().includes('balance') || 
                         fieldName.toLowerCase().includes('total') ||
                         fieldName.toLowerCase().includes('price') ||
                         fieldName.toLowerCase().includes('cost'))) {
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        return value.toLocaleString('en-US');
    }
    
    // Handle booleans
    if (typeof value === 'boolean') {
        return value ? '<span style="color: #059669;">‚úì Yes</span>' : '<span style="color: #dc2626;">‚úó No</span>';
    }
    
    return escapeHtml(String(value));
};

// Show entity data modal
window.showEntityDataModal = async function(entityName, records, loading, errorMessage, paginationState = null) {
    // Detect dark mode
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const bgColor = isDarkMode ? '#2d2d2d' : '#ffffff';
    const borderColor = isDarkMode ? '#404040' : '#e5e7eb';
    const textColor = isDarkMode ? '#e0e0e0' : '#111827';
    const textSecondary = isDarkMode ? '#b0b0b0' : '#6b7280';
    const buttonBg = isDarkMode ? '#3a3a3a' : '#f3f4f6';
    const buttonBgHover = isDarkMode ? '#4a4a4a' : '#e5e7eb';
    
    // Create or update modal
    let modal = document.getElementById('entity-data-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'entity-data-modal';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;';
        modal.innerHTML = `
            <div style="max-width: 1400px; margin: 2rem auto; background: ${bgColor}; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); min-height: 400px; color: ${textColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid ${borderColor};">
                    <h2 style="margin: 0; color: ${textColor}; font-size: 1.5rem;" id="modal-entity-name"></h2>
                    <button onclick="closeEntityDataModal()" style="background: ${buttonBg}; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 1.25rem; color: ${textSecondary};" onmouseover="this.style.background='${buttonBgHover}'" onmouseout="this.style.background='${buttonBg}'">√ó</button>
                </div>
                <div id="modal-content" style="padding: 1.5rem; overflow-x: auto; color: ${textColor};"></div>
            </div>
        `;
        document.body.appendChild(modal);
    } else {
        // Update existing modal colors if dark mode changed
        const modalContent = modal.querySelector('div[style*="max-width"]');
        if (modalContent) {
            modalContent.style.background = bgColor;
            modalContent.style.color = textColor;
            const header = modalContent.querySelector('div[style*="display: flex"]');
            if (header) {
                header.style.borderBottomColor = borderColor;
            }
            const title = document.getElementById('modal-entity-name');
            if (title) {
                title.style.color = textColor;
            }
            const closeBtn = header?.querySelector('button');
            if (closeBtn) {
                closeBtn.style.background = buttonBg;
                closeBtn.style.color = textSecondary;
            }
        }
    }
    
    // Update modal content
    document.getElementById('modal-entity-name').textContent = entityName;
    const content = document.getElementById('modal-content');
    
    if (loading) {
        const spinnerBorder = isDarkMode ? '#3a3a3a' : '#f3f4f6';
        const loadingTextColor = isDarkMode ? '#b0b0b0' : '#6b7280';
        content.innerHTML = `<div style="text-align: center; padding: 3rem;"><div style="display: inline-block; width: 40px; height: 40px; border: 4px solid ${spinnerBorder}; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div><div style="margin-top: 1rem; color: ${loadingTextColor};">Loading entity data...</div></div><style>@keyframes spin { to { transform: rotate(360deg); } }</style>`;
        modal.style.display = 'block';
        return;
    }
    
    if (errorMessage) {
        const errorColor = isDarkMode ? '#ef4444' : '#dc2626';
        content.innerHTML = `<div style="text-align: center; padding: 3rem; color: ${errorColor};">${escapeHtml(errorMessage)}</div>`;
        modal.style.display = 'block';
        return;
    }
    
    if (!records || records.length === 0) {
        const emptyTextColor = isDarkMode ? '#b0b0b0' : '#6b7280';
        content.innerHTML = `<div style="text-align: center; padding: 3rem; color: ${emptyTextColor};">No records found</div>`;
        modal.style.display = 'block';
        return;
    }
    
    // Collect fields from records
    const allFieldsSet = new Set();
    records.forEach((record) => {
        Object.keys(record).forEach(key => {
            allFieldsSet.add(key);
        });
    });
    
    const allFields = Array.from(allFieldsSet);
    const displayRecords = records;
    
    // Build table
    const tableHeaderBg = isDarkMode ? '#1a1a1a' : '#f9fafb';
    const tableBorder = isDarkMode ? '#404040' : '#e5e7eb';
    const tableText = isDarkMode ? '#e0e0e0' : '#374151';
    const tableTextSecondary = isDarkMode ? '#b0b0b0' : '#6b7280';
    const tableTextPrimary = isDarkMode ? '#e0e0e0' : '#111827';
    
    // Pagination info and controls
    const pagination = paginationState || entityModalState;
    const currentPage = pagination.currentPage || 1;
    const totalPages = pagination.totalPages || 1;
    const totalRecords = pagination.totalRecords || displayRecords.length;
    const startRecord = (currentPage - 1) * (pagination.limit || 20) + 1;
    const endRecord = Math.min(startRecord + displayRecords.length - 1, totalRecords);
    
    let html = `<div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">`;
    html += `<div style="color: ${tableTextSecondary}; font-size: 0.875rem;">
        Showing <span style="font-weight: 600; color: ${tableTextPrimary};">${startRecord}-${endRecord}</span> of <span style="font-weight: 600; color: ${tableTextPrimary};">${totalRecords}</span> record${totalRecords !== 1 ? 's' : ''} ‚Ä¢ 
        <span style="font-weight: 600; color: ${tableTextPrimary};">${allFields.length}</span> field${allFields.length !== 1 ? 's' : ''}
    </div>`;
    
    // Pagination controls
    if (totalPages > 1) {
        const buttonStyle = `background: ${buttonBg}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; color: ${textColor}; margin: 0 0.25rem; transition: all 0.2s;`;
        const buttonDisabledStyle = `background: ${isDarkMode ? '#1a1a1a' : '#f3f4f6'}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 0.5rem 1rem; font-size: 0.875rem; color: ${textSecondary}; margin: 0 0.25rem; cursor: not-allowed; opacity: 0.5;`;
        const buttonHoverStyle = `background: ${buttonBgHover};`;
        
        html += `<div style="display: flex; align-items: center; gap: 0.5rem;">`;
        
        // First page button
        if (currentPage > 1) {
            html += `<button onclick="loadEntityPage(1)" style="${buttonStyle}" onmouseover="this.style.background='${buttonBgHover}'" onmouseout="this.style.background='${buttonBg}'" title="First page">¬´¬´</button>`;
        } else {
            html += `<button disabled style="${buttonDisabledStyle}">¬´¬´</button>`;
        }
        
        // Previous page button
        if (currentPage > 1) {
            html += `<button onclick="loadEntityPage(${currentPage - 1})" style="${buttonStyle}" onmouseover="this.style.background='${buttonBgHover}'" onmouseout="this.style.background='${buttonBg}'" title="Previous page">‚Äπ Prev</button>`;
        } else {
            html += `<button disabled style="${buttonDisabledStyle}">‚Äπ Prev</button>`;
        }
        
        // Page number display
        html += `<span style="color: ${textColor}; font-size: 0.875rem; padding: 0 0.5rem;">Page <strong>${currentPage}</strong> of <strong>${totalPages}</strong></span>`;
        
        // Next page button
        if (currentPage < totalPages) {
            html += `<button onclick="loadEntityPage(${currentPage + 1})" style="${buttonStyle}" onmouseover="this.style.background='${buttonBgHover}'" onmouseout="this.style.background='${buttonBg}'" title="Next page">Next ‚Ä∫</button>`;
        } else {
            html += `<button disabled style="${buttonDisabledStyle}">Next ‚Ä∫</button>`;
        }
        
        // Last page button
        if (currentPage < totalPages) {
            html += `<button onclick="loadEntityPage(${totalPages})" style="${buttonStyle}" onmouseover="this.style.background='${buttonBgHover}'" onmouseout="this.style.background='${buttonBg}'" title="Last page">¬ª¬ª</button>`;
        } else {
            html += `<button disabled style="${buttonDisabledStyle}">¬ª¬ª</button>`;
        }
        
        html += `</div>`;
    }
    
    html += '</div>';
    
    html += `<div style="overflow-x: auto; border: 1px solid ${tableBorder}; border-radius: 8px;">`;
    html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
    
    // Table header
    html += `<thead style="background: ${tableHeaderBg}; border-bottom: 2px solid ${tableBorder}; position: sticky; top: 0; z-index: 10;">`;
    html += '<tr>';
    html += `<th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: ${tableText}; border-right: 1px solid ${tableBorder}; min-width: 80px; max-width: 100px; position: sticky; left: 0; background: ${tableHeaderBg}; z-index: 11;">#</th>`;
    
    allFields.forEach((field) => {
        html += `<th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: ${tableText}; border-right: 1px solid ${tableBorder}; min-width: 150px; max-width: 250px; vertical-align: top; word-break: break-word;">
            ${escapeHtml(field)}
        </th>`;
    });
    
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    // Table body
    const MAX_ROWS = 100;
    const rowsToRender = displayRecords.slice(0, MAX_ROWS);
    rowsToRender.forEach((record, recordIndex) => {
        html += '<tr style="border-bottom: 1px solid ' + tableBorder + ';">';
        
        // Row number (account for pagination - show actual record number)
        const actualRecordNumber = startRecord + recordIndex;
        html += `<td style="padding: 0.75rem 1rem; background: ${tableHeaderBg}; font-weight: 600; color: ${tableTextSecondary}; border-right: 1px solid ${tableBorder}; position: sticky; left: 0; z-index: 10; text-align: center;">${actualRecordNumber}</td>`;
        
        // Fields
        allFields.forEach((field) => {
            let value = record.hasOwnProperty(field) ? record[field] : null;
            
            if (field === 'original_data' && value !== null && value !== undefined) {
                html += `<td style="padding: 0.75rem 1rem; color: ${tableText}; border-right: 1px solid ${tableBorder}; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 0.75rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; max-width: 600px; background: ${isDarkMode ? '#0a0a0a' : '#f9fafb'};">${escapeHtml(JSON.stringify(value, null, 2))}</td>`;
                return;
            }
            
            html += `<td style="padding: 0.75rem 1rem; border-right: 1px solid ${tableBorder}; vertical-align: top; word-wrap: break-word; word-break: break-word; white-space: normal; max-width: 250px; color: ${tableText};">`;
            
            // Add links for file entities (image, document, video, audio)
            const isFileEntity = record.data_type === 'file' || ['image', 'document', 'video', 'audio', 'archive'].includes((record.data_type || '').toLowerCase());
            const isFileField = ['file_name', 'file_path', 'name', 'title'].includes(field) && isFileEntity;
            const hasId = record.id || record._id;
            
            if (isFileField && hasId && value) {
                // Create link to content endpoint
                const fileId = record.id || record._id;
                const contentUrl = API_URL + '/api/tenants/' + TENANT_ID + '/content/' + encodeURIComponent(fileId);
                const linkColor = isDarkMode ? '#60a5fa' : '#2563eb';
                html += `<a href="${contentUrl}" target="_blank" style="color: ${linkColor}; text-decoration: underline; font-weight: 500;" title="Open file">${escapeHtml(String(value))}</a>`;
                html += ` <span style="color: ${tableTextSecondary}; font-size: 0.75rem;" title="Click to view file">üîó</span>`;
            } else if (value === null) {
                html += 'null';
            } else if (value === undefined) {
                html += 'undefined';
            } else if (typeof value === 'object') {
                html += escapeHtml(JSON.stringify(value));
            } else {
                html += escapeHtml(String(value));
            }
            
            html += '</td>';
        });
        
        html += '</tr>';
    });
    
    if (displayRecords.length > MAX_ROWS) {
        html += `<tr><td colspan="${allFields.length + 1}" style="padding: 1rem; text-align: center; color: ${tableTextSecondary}; background: ${tableHeaderBg};">Showing ${rowsToRender.length} of ${displayRecords.length} records</td></tr>`;
    }
    
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    content.innerHTML = html;
    modal.style.display = 'block';
};

// Close entity data modal
window.closeEntityDataModal = function() {
    const modal = document.getElementById('entity-data-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

// Close modal on outside click
document.addEventListener('click', function(event) {
    const modal = document.getElementById('entity-data-modal');
    if (modal && event.target === modal) {
        closeEntityDataModal();
    }
});

// Store pagination state for entity modal
let entityModalState = {
    entityType: null,
    entityName: null,
    currentPage: 1,
    totalPages: 1,
    totalRecords: 0,
    limit: 20
};

// Show entity data (fetches and displays) with pagination
window.showEntityData = async function(entityType, entityName, page = 1) {
    try {
        console.log('üîç Opening entity data modal for:', entityType, entityName, 'page:', page);
        
        // Update pagination state
        entityModalState.entityType = entityType;
        entityModalState.entityName = entityName;
        entityModalState.currentPage = page;
        
        // Show loading modal
        showEntityDataModal(entityName, null, true, null, entityModalState);
        
        // Calculate offset from page number
        const offset = (page - 1) * entityModalState.limit;
        
        // Fetch entity data using the new Universal Find endpoint
        // OPTIMIZED: Use empty query instead of '*' for better performance
        // The data_type filter is sufficient to get all records of this type
        // Add timeout to prevent hanging on slow requests
        // 5 second timeout - if query takes longer, suggest using search instead
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
        
        // Determine if this is a file-based entity (from Crema data)
        // File-based entities use mimeTypes filter instead of data_type filter
        const isFileBasedEntity = ['image', 'images', 'video', 'videos', 'audio', 'document', 'documents', 'archive', 'archives'].includes(entityType.toLowerCase());
        
        // Build request body - use mimeTypes for file entities, data_type for others
        const requestBody = {
            query: '',  // Empty query - backend converts to '*' when filter is provided
            limit: entityModalState.limit,
            offset: offset
        };
        
        if (isFileBasedEntity) {
            // File-based entities: use mimeTypes filter based on entity type
            const entityTypeLower = entityType.toLowerCase();
            if (entityTypeLower.includes('image')) {
                requestBody.mimeTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            } else if (entityTypeLower.includes('video')) {
                requestBody.mimeTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo'];
            } else if (entityTypeLower.includes('audio')) {
                requestBody.mimeTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4'];
            } else if (entityTypeLower.includes('document')) {
                requestBody.mimeTypes = ['application/pdf', 'text/plain', 'application/msword'];
            }
        } else {
            // Regular entities: use data_type filter
            requestBody.data_type = entityType;
        }
        
        const response = await fetch(API_URL + '/api/tenants/' + TENANT_ID + '/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`Search failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Handle Universal Search endpoint response format
        const results = data.data?.results || data.results || [];
        const totalRecords = data.data?.total || 0;
        const totalPages = data.data?.total_pages || Math.ceil(totalRecords / entityModalState.limit);
        const hasMore = data.data?.has_more || false;
        
        // Update pagination state
        entityModalState.totalRecords = totalRecords;
        entityModalState.totalPages = totalPages;
        
        if (!data.success || results.length === 0) {
            if (page === 1) {
                showEntityDataModal(entityName, [], false, 'No data found or search failed', entityModalState);
            } else {
                showEntityDataModal(entityName, [], false, 'No more records found', entityModalState);
            }
            return;
        }
        
        const records = results;
        const validRecords = records.filter(record => {
            if (!record.original_data) {
                console.error(`‚ùå Record missing original_data:`, record);
                return false;
            }
            if (!record.data_type) {
                console.error(`‚ùå Record missing data_type:`, record);
                return false;
            }
            return true;
        });
        
        if (validRecords.length > 0) {
            console.log(`‚úÖ Loaded ${validRecords.length} valid ${entityType} records (page ${page}/${totalPages}, total: ${totalRecords})`);
            showEntityDataModal(entityName, validRecords, false, null, entityModalState);
        } else {
            showEntityDataModal(entityName, [], false, `No ${entityType} data found.`, entityModalState);
        }
    } catch (error) {
        console.error('‚ùå Failed to fetch entity data:', error);
        let errorMessage = 'Error loading data: ' + error.message;
        if (error.name === 'AbortError') {
            errorMessage = `Request timed out after 5 seconds. This entity has ${entityModalState.totalRecords || 'many'} records. ` +
                          `Try using the search box above with a specific query instead, or search for "${entityType}" to filter results.`;
        }
        showEntityDataModal(entityName, [], false, errorMessage, entityModalState);
    }
};

// Pagination helper functions
window.loadEntityPage = function(page) {
    if (entityModalState.entityType && entityModalState.entityName) {
        showEntityData(entityModalState.entityType, entityModalState.entityName, page);
    }
};
    </script>
</body>
</html>

